<!DOCTYPE html>
<html>
<head>
    <title>Programa Festes del Carme </title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>
<body>
    <div id="app">
        <div class="container-fluid">
            <!-- Exemple pàgina buida -->
            <div class="row page page-break page-container p-0">
                <div class="col-12 p-0">
                    <div class="page-content">
                        <div class="logo-primera-pagina">
                            <img src="resources/LogoFestes2019.png" class="d-block h-100 img-primera-pg mx-auto" alt="logo">
                        </div>
                        <div class="texte-primera-pagina">
                            <p>
                                Pell de gallina posa, <br>
                                quan començam a sentir... <br>
                                Aquell renou de paperí,<br>
                                aquell que anuncia una cosa;<br>
                                Un renou que no fa nosa<br>
                                a tots els que som d’aquí.
                            </p>
                            <p>
                                Venen dies...Tots de festa,<br>
                                molts moments per compartir,<br>
                                Ja ho sabeu! Heu de venir,<br>
                                Pòrtol se manifesta!
                            </p>
                            <p>
                                Celebracions com aquesta,<br>
                                que és només un pic a l’any,<br>
                                no ha estat mai cap desengany,<br>
                                és tan sols sa nostra FESTA!!!
                            </p>
                            <p>
                                Molts d’anys i bons Portolans i Portolanes!!!!
                            </p>
                            <p>
                                Neus Serra
                            </p>
                        </div>
                        <div class="festeros-primera-pagina">

                        </div>
                    </div>
                </div>
            </div>
            <!-- Fi exemple pàgina buida -->
            <div class="row page page-break page-container" v-for="(pagina, i) in pagines" :key="i">
                <div class="col-12 p-0">
                    <div class="page-content h-100">
                        <div class="anunciant" :class="anunciant.css"  v-for="(anunciant, j) in pagina" :key="j">
                            <!-- <img :src="anunciant.E" class="w-90 h-100 mx-auto d-block"  alt="anunciant"> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
    <script>
        const getFullYear = () => new Date().getFullYear()

        document.body.onload = function () {
            document.title += (' ' + getFullYear())
        }
        new Vue({
            el: '#app',
            data: {
                pagines: '',
                pagina: [],
                fd: [],
                pending: []
            },
            methods: {
                algo: function(anunciant){

                    console.log(anunciant);

                    let preu = parseInt(anunciant.C);

                    if(preu >= 100){
                        this.fd.push([anunciant]);
                    }
                    else if(this.pagina.length == 0){
                        this.pagina.push(anunciant);
                    }
                    else{
                        console.log("else")
                        let num40 = 0;
                        let num60 = 0;
                        let num80 = 0;

                        this.pagina.forEach(element => {
                            if(element.C == "40")
                                num40++;
                            else if(element.C == "60")
                                num60++;
                            else if(element.C == "80")
                                num80++;
                        })

                        console.log("preu "+ preu)
                        console.log("num40 " + num40);
                        console.log("num60 " + num60)
                        console.log("num80 "+num80);

                        if(num40 == 4){
                            this.fd.push(this.pagina)
                            console.log("entro 40")
                            this.pagina = []
                            this.pagina.push(anunciant);
                            
                        }
                        else if(num60 == 2){
                            this.fd.push(this.pagina);
                            this.pagina = []
                            this.pagina.push(anunciant);
                        }
                        else if(num40 == 2 && num60 == 1){
                            this.fd.push(this.pagina);
                            this.pagina = []
                            this.pagina.push(anunciant);
                        }
                        else if(num40 == 1 && num80 == 1){
                            this.fd.push(this.pagina);
                            this.pagina = []
                            this.pagina.push(anunciant);
                        }
                        else{

                            const pageLength = this.pagina.length

                            const checkPending = () => {
                                this.pending.push(anunciant)
                                const pendingIndex = this.pending.findIndex(pendingAnunciant => {
                                    if (pageLength === 1) {

                                        if (num40 > 0) return pendingAnunciant

                                        else if (num60 > 0 && parseInt(pendingAnunciant.C) < 80)  return pendingAnunciant

                                    } else if (pageLength === 2) {

                                        if (parseInt(pendingAnunciant.C) === 60 && num40 === 2) return pendingAnunciant

                                        else if (parseInt(pendingAnunciant.C) === 40 && num60 === 1 && num40 === 1) return pendingAnunciant


                                    } else if (pageLength === 3) { 

                                        if (parseInt(pendingAnunciant.C) === 40) return pendingAnunciant

                                    }
                                })
                                if (pendingIndex !== -1) {
                                    this.pagina.push(this.pending[pendingIndex])
                                    this.pending.splice(pendingIndex)
                                }
                            }

                            if (pageLength === 1) {

                                if (num40 > 0) this.pagina.push(anunciant)

                                else if (num60 > 0 && preu < 80)  this.pagina.push(anunciant)

                                else checkPending()

                            } else if (pageLength === 2) {

                                if (preu === 60 && num40 === 2) this.pagina.push(anunciant)
                                
                                else if (preu === 40 && num60 === 1 && num40 === 1) this.pagina.push(anunciant)

                                else checkPending()

                            } else if (pageLength === 3) { 

                                if (preu === 40) this.pagina.push(anunciant)

                                else checkPending()

                            }
          
                        }
                    }


                }
            },
            created: async function () {

                const data = await fetch('/resources/Anunciants2019/anunciants-2019.json')
                const anunciants = await data.json()
                console.log(anunciants)
                anunciants.shift()


                this.pagines = anunciants.reduce((prev, curr) => {
                    
                    const actualIndex = prev.length && prev.length - 1 || 0

                    const infoPaginaActual = prev.length > 0 && prev[actualIndex].reduce((prevAnunciant, currAnunciant) => {
                        const preu = parseInt(currAnunciant.C)
                        if (preu > 80) prevAnunciant.anunciants100++
                        else if (preu === 80) prevAnunciant.anunciants80++
                        else if (preu === 60) prevAnunciant.anunciants60++
                        else if (preu === 40) prevAnunciant.anunciants40++
                        prevAnunciant.anunciants++
                        return prevAnunciant
                    }, {
                        anunciants40: 0,
                        anunciants60: 0,
                        anunciants80: 0,
                        anunciants100: 0,
                        anunciants: 0
                    })

                    if (!infoPaginaActual) prev[actualIndex] = [curr]

                    else {
                        const preu = parseInt(curr.C)
                        function checkPriceFn(price) {
                            if (price > 80) return {
                                max: 0,
                                min: 0
                            } 
                            else if (price === 40) return {
                                max: 160,
                                min: 40
                            }
                            else if (price === 60) return {
                                max: 140,
                                min: 60
                            }
                            else if (price === 80) return {
                                max: 120,
                                min: 80
                            }
                        }
                        function checkPaginaPriceFn(pagina) {
                            const totalPagina = pagina.reduce((acumulatori, anun) => acumulatori + parseInt(anun.C), 0) + preu
                            const checkPricePage = [...pagina.map(_ => checkPriceFn(parseInt(_.C))), checkPriceFn(preu)]
                            return checkPricePage.every(ch => (totalPagina <= ch.max && totalPagina >= ch.min));
                        }
                        if (!prev[actualIndex]) prev[actualIndex] = []
                        const ableIndex = prev.findIndex(checkPaginaPriceFn)
                        const checkActualPagina = checkPaginaPriceFn(prev[actualIndex]);
                        
                        if (checkActualPagina) {

                            if (ableIndex !== -1) prev[ableIndex].push(curr)
                            else {
                                if (preu === 40 && (infoPaginaActual.anunciants40 < 4 || infoPaginaActual.anunciants60 === 1 || infoPaginaActual.anunciants80 === 1 || infoPaginaActual.anunciants < 4 || !infoPaginaActual)) prev[actualIndex].push(curr)
                                else if (preu === 60 && (infoPaginaActual.anunciants40 < 3 || infoPaginaActual.anunciants60 === 1 || infoPaginaActual.anunciants < 3 || !infoPaginaActual)) prev[actualIndex].push(curr)
                                else if (preu === 80 && (infoPaginaActual.anunciants40 === 1 || infoPaginaActual.anunciants < 2 || !infoPaginaActual)) prev[actualIndex].push(curr)
                            }
                        } else {
                            //const ableIndex = prev.findIndex(pagina => (pagina.reduce((acumulatori, anun) => acumulatori + parseInt(anun.C), 0)) + preu < 80)

                            if (ableIndex !== -1) prev[ableIndex].push(curr)
                            else prev[actualIndex + 1 ] = [curr]
                        }

                    }

                    return prev

                }, [])
                .map(pagina => 
                    pagina.map(anunciant => {
                        switch (anunciant.C) {
                            case '40': 
                                anunciant.css = 'class-40' 
                                break;
                            case '60':
                                anunciant.css = 'class-60'
                                break;
                            case '80':
                                anunciant.css = 'class-80';
                                break;
                            default:
                                anunciant.css = 'class-max'
                                break;
                        }
                        return anunciant;
                    })
                )
                console.log(

                    this.pagines.reduce((prev, curr) => prev + curr.length, 0),
                    this.pagines

                )
            }
        })
    </script>
</body>
</html>